<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>白嫖神器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
      
      
      #searchBtn {
    display: block; /* 使按钮成为块级元素 */
    width: 100%;     /* 设置按钮宽度为80%容器宽度 */
    margin: 15px auto; /* 上下15px外边距，左右自动（实现水平居中） */
    padding: 8px;  /* 增加内边距使按钮更长条 */
    text-align: center; /* 文字居中 */
    font-size: 16px; /* 可选：增大字体 */
    font-weight: bold; /* 可选：加粗字体 */
}
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], select {
            width: 100%;
            text-align: center; /* 文字居中 */
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #results, #episodes {
            margin-top: 20px;
            display: none;
        }
        .result-item, .episode-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .result-item:hover, .episode-item:hover {
            background-color: #f9f9f9;
        }
        #video-container {
            margin-top: 20px;
            display: none;
            width: 100%;
        }
        video {
            width: 100%;
            background-color: #000;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        /* 添加复制链接按钮样式 */
        #copyLinkBtn {
            display: block;
            width: 80%;
            margin: 10px auto;
            padding: 12px;
            background-color: white;
            color: black;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
        }
        #copyLinkBtn:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>影视网</h1>
        &nbsp
        
        <div class="form-group">
            <input type="text" id="movieName" placeholder="输入影视名称">
        </div>
        
        <button id="searchBtn" onclick="searchMovie()">搜索</button>
        <div id="errorMsg" class="error"></div>
        
        <div id="loading" class="loading" style="display: none;">请稍等，加载中...</div>
        
        <div id="results"></div>
        <div id="episodes"></div>
        
        <div id="video-container">
            <video id="videoElement" controls>
                您的浏览器不支持HTML5视频
            </video>
        </div>
    </div>

    <script>
        const API_BASE_URL = "https://api.allorigins.win/raw?url=https://moduzy.net/api.php/provide/vod/";
        let currentMovieList = [];
        let currentEpisodeList = [];
        let currentSelectedEpisodeUrl = ""; // 存储当前选中的集数URL
        
        document.getElementById('movieName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMovie();
            }
        });
        
        async function searchMovie() {
            const movieName = document.getElementById("movieName").value.trim();
            if (!movieName) {
                showError("请输入影视名称：");
                return;
            }
            
            const searchBtn = document.getElementById("searchBtn");
            searchBtn.disabled = true;
            document.getElementById("loading").style.display = "block";
            document.getElementById("errorMsg").textContent = "";
            document.getElementById("results").style.display = "none";
            document.getElementById("episodes").style.display = "none";
            document.getElementById("video-container").style.display = "none";
            
            // 隐藏复制按钮
            const copyBtn = document.getElementById("copyLinkBtn");
            if (copyBtn) copyBtn.style.display = "none";
            
            try {
                const response = await fetch(`${API_BASE_URL}?ac=detail&wd=${encodeURIComponent(movieName)}&pg=1`);
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.list || data.list.length === 0) {
                    throw new Error("未找到相关影视");
                }
                
                currentMovieList = data.list.map(item => ({
                    id: item.vod_id,
                    name: item.vod_name,
                    playUrl: item.vod_play_url
                }));
                
                displayResults();
            } catch (error) {
                showError(error.message);
                console.error("搜索出错:", error);
            } finally {
                searchBtn.disabled = false;
                document.getElementById("loading").style.display = "none";
            }
        }
        
        function displayResults() {
            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "<h3>注：选择影视后，下滑勾选集数！</h3>";
            
            currentMovieList.forEach((movie, index) => {
                const item = document.createElement("div");
                item.className = "result-item";
                item.textContent = movie.name;
                item.onclick = () => selectMovie(index);
                resultsDiv.appendChild(item);
            });
            
            resultsDiv.style.display = "block";
        }
        
        function selectMovie(index) {
            const movie = currentMovieList[index];
            console.log("选择的影视", movie);
            
            // 隐藏复制按钮
            const copyBtn = document.getElementById("copyLinkBtn");
            if (copyBtn) copyBtn.style.display = "none";
            
            // 解析播放地址
            try {
                const playUrl = movie.playUrl.replace(/\\/g, "");
                currentEpisodeList = parseEpisodes(playUrl);
                
                if (currentEpisodeList.length === 0) {
                    throw new Error("该影视暂无播放资源");
                }
                
                displayEpisodes();
            } catch (error) {
                showError(error.message);
                console.error("解析播放地址出错:", error);
            }
        }
        
        function parseEpisodes(playUrl) {
            const episodes = [];
            const episodeParts = playUrl.split('#');
            
            episodeParts.forEach(part => {
                if (!part) return;
                
                const match = part.match(/^(.+?)\$(https?:\/\/.+)/);
                if (match && match.length >= 3) {
                    episodes.push({
                        name: match[1].trim(),
                        url: match[2].trim()
                    });
                }
            });
            
            return episodes;
        }
        
        function displayEpisodes() {
            const episodesDiv = document.getElementById("episodes");
            episodesDiv.innerHTML = "<h3>请选择集数:</h3>";
            
            // 添加复制链接按钮（初始隐藏）
            const copyBtn = document.createElement("button");
            copyBtn.id = "copyLinkBtn";
            copyBtn.textContent = "复制链接";
            copyBtn.style.display = "none"; // 初始隐藏
            copyBtn.onclick = copyVideoUrl;
            episodesDiv.appendChild(copyBtn);
            
            currentEpisodeList.forEach((episode, index) => {
                const item = document.createElement("div");
                item.className = "episode-item";
                item.textContent = episode.name;
                item.onclick = () => playVideo(index);
                episodesDiv.appendChild(item);
            });
            
            episodesDiv.style.display = "block";
            document.getElementById("video-container").style.display = "none";
        }
        
        function playVideo(index) {
            const episode = currentEpisodeList[index];
            console.log("播放:", episode);
            
            const videoContainer = document.getElementById("video-container");
            const videoElement = document.getElementById("videoElement");
            
            // 清除之前的source元素
            while (videoElement.firstChild) {
                videoElement.removeChild(videoElement.firstChild);
            }
            
            // 创建新的source元素
            const source = document.createElement("source");
            source.src = episode.url;
            source.type = getVideoType(episode.url);
            videoElement.appendChild(source);
            
            videoContainer.style.display = "block";
            videoElement.load();
            
            // 尝试自动播放
            videoElement.play().catch(e => {
                console.log("自动播放被阻止:", e);
            });
            
            // 滚动到视频区域
            videoContainer.scrollIntoView({ behavior: "smooth" });
            
            // 显示复制链接按钮
            currentSelectedEpisodeUrl = episode.url;
            document.getElementById("copyLinkBtn").style.display = "block";
        }
        
        function getVideoType(url) {
            if (url.includes('.m3u8')) {
                return 'application/x-mpegURL';
            } else if (url.includes('.mp4')) {
                return 'video/mp4';
            } else if (url.includes('.webm')) {
                return 'video/webm';
            } else if (url.includes('.ogg')) {
                return 'video/ogg';
            }
            return 'video/mp4'; // 默认
        }
        
        function copyVideoUrl() {
            if (!currentSelectedEpisodeUrl) return;
            
            navigator.clipboard.writeText(currentSelectedEpisodeUrl)
                .then(() => {
                    alert("链接已复制到剪贴板！");
                })
                .catch(err => {
                    console.error("复制失败:", err);
                    alert("复制失败，请手动复制链接");
                });
        }
        
        function showError(message) {
            document.getElementById("errorMsg").textContent = message;
        }
    </script>
</body>
</html>